# =============================================================================
# DEparrow Production Stack
# =============================================================================
#
# IMPORTANT: This configuration requires environment variables to be set.
# Copy .env.example to .env and update all values before running.
#
# Usage:
#   cp .env.example .env
#   # Edit .env with your secure values
#   docker-compose -f docker-compose.prod.yml up -d
#
# Security Notes:
#   - NEVER commit .env files to version control
#   - Use strong, unique passwords for production
#   - Rotate secrets regularly
#   - Consider using Docker Secrets or external secret management
#
# =============================================================================

services:
  # ===========================================
  # Meta-OS Control Plane
  # ===========================================
  # Core API server for the DEparrow platform
  # Requires: DEPARROW_SECRET_KEY (JWT signing)
  metaos:
    build:
      context: ./metaos-layer
      dockerfile: Dockerfile
    image: deparrow/metaos:latest
    container_name: deparrow-metaos
    restart: unless-stopped
    ports:
      - "${METAOS_PORT:-8080}:8080"
    environment:
      # JWT signing key - MUST be changed in production
      # Generate with: openssl rand -hex 32
      - DEPARROW_SECRET_KEY=${DEPARROW_SECRET_KEY:?DEPARROW_SECRET_KEY is required}
      # Database connection - uses POSTGRES_USER, POSTGRES_PASSWORD
      - DATABASE_URL=postgresql://${POSTGRES_USER:-deparrow}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@postgres:5432/${POSTGRES_DB:-deparrow}
      # Redis connection (no auth by default, add password in production)
      - REDIS_URL=redis://${REDIS_HOST:-redis}:${REDIS_PORT:-6379}/${REDIS_DB:-0}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - deparrow-network

  # ===========================================
  # GUI Dashboard
  # ===========================================
  # Web interface for DEparrow
  gui:
    build:
      context: ./gui-layer
      dockerfile: Dockerfile
    image: deparrow/gui:latest
    container_name: deparrow-gui
    restart: unless-stopped
    ports:
      - "${GUI_PORT:-3000}:3000"
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:8080}
      - NODE_ENV=production
    depends_on:
      - metaos
    networks:
      - deparrow-network

  # ===========================================
  # Bacalhau Orchestrator
  # ===========================================
  # Central coordinator for compute jobs
  bacalhau-orchestrator:
    image: ghcr.io/bacalhau-project/bacalhau:${BACALHAU_VERSION:-latest}
    container_name: deparrow-orchestrator
    restart: unless-stopped
    command: serve --orchestrator
    ports:
      - "${ORCHESTRATOR_NATS_PORT:-4222}:4222"
      - "${ORCHESTRATOR_API_PORT:-1234}:1234"
    environment:
      - BACALHAU_NODE_NETWORK_TYPE=nats
      - BACALHAU_NODE_NAME=orchestrator-1
    volumes:
      - bacalhau-data:/root/.bacalhau
    networks:
      - deparrow-network

  # ===========================================
  # Bacalhau Compute Node (Local)
  # ===========================================
  # Executes compute jobs (requires Docker socket)
  # Security: Ensure Docker socket access is restricted
  bacalhau-compute:
    image: ghcr.io/bacalhau-project/bacalhau:${BACALHAU_VERSION:-latest}
    container_name: deparrow-compute-1
    restart: unless-stopped
    command: serve --compute --orchestrators=nats://bacalhau-orchestrator:4222
    environment:
      - BACALHAU_NODE_NAME=compute-local-1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - bacalhau-orchestrator
    networks:
      - deparrow-network

  # ===========================================
  # PostgreSQL Database
  # ===========================================
  # Persistent storage for Meta-OS
  # Security: POSTGRES_PASSWORD MUST be set to a strong password
  postgres:
    image: postgres:${POSTGRES_VERSION:-15}-alpine
    container_name: deparrow-postgres
    restart: unless-stopped
    environment:
      # Database credentials - MUST change POSTGRES_PASSWORD in production
      - POSTGRES_USER=${POSTGRES_USER:-deparrow}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=${POSTGRES_DB:-deparrow}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-deparrow}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - deparrow-network

  # ===========================================
  # Redis Cache
  # ===========================================
  # In-memory cache and session storage
  # Note: Consider adding AUTH password for production
  redis:
    image: redis:${REDIS_VERSION:-7}-alpine
    container_name: deparrow-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - deparrow-network

  # ===========================================
  # Prometheus Monitoring
  # ===========================================
  # Metrics collection and alerting
  prometheus:
    image: prom/prometheus:${PROMETHEUS_VERSION:-latest}
    container_name: deparrow-prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - deparrow-network

  # ===========================================
  # Grafana Dashboards
  # ===========================================
  # Visualization and monitoring dashboards
  # Security: GF_SECURITY_ADMIN_PASSWORD MUST be changed
  grafana:
    image: grafana/grafana:${GRAFANA_VERSION:-latest}
    container_name: deparrow-grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      # Admin password - MUST change in production
      # Generate with: openssl rand -base64 24
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD is required}
      - GF_USERS_ALLOW_SIGN_UP=${GRAFANA_ALLOW_SIGNUP:-false}
      # Optional: Disable anonymous access
      - GF_AUTH_ANONYMOUS_ENABLED=${GRAFANA_ANONYMOUS:-false}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/dashboards:/etc/grafana/provisioning/dashboards
    depends_on:
      - prometheus
    networks:
      - deparrow-network

networks:
  deparrow-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  bacalhau-data:
  prometheus-data:
  grafana-data: