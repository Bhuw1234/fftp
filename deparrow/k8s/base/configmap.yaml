apiVersion: v1
kind: ConfigMap
metadata:
  name: deparrow-config
  labels:
    app.kubernetes.io/name: deparrow
    app.kubernetes.io/component: config
data:
  # Application settings
  LOG_LEVEL: "info"
  NODE_ENV: "production"
  
  # Meta-OS settings
  DEPARROW_HOST: "0.0.0.0"
  DEPARROW_PORT: "8080"
  DEPARROW_CREDIT_RATE: "0.1"
  DEPARROW_SUBMISSION_COST: "1.0"
  DEPARROW_MIN_BALANCE: "10.0"
  
  # Database connection
  POSTGRES_HOST: "postgres"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "deparrow"
  POSTGRES_USER: "deparrow"
  
  # Redis connection
  REDIS_HOST: "redis"
  REDIS_PORT: "6379"
  
  # Bacalhau settings
  BACALHAU_NODE_NETWORK_TYPE: "nats"
  ORCHESTRATOR_PORT: "4222"
  ORCHESTRATOR_API_PORT: "1234"
  
  # Agent settings
  AGENT_MODEL: "claude-3-5-sonnet-20241022"
  AGENT_MAX_ITERATIONS: "10"
  AGENT_TEMPERATURE: "0.7"
  
  # Monitoring
  PROMETHEUS_ENABLED: "true"
  METRICS_PATH: "/metrics"
  METRICS_PORT: "9090"
  
  # GUI settings
  VITE_API_URL: "http://metaos:8080"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: monitoring
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'deparrow'
        environment: 'production'

    alerting:
      alertmanagers:
        - static_configs:
            - targets: []

    rule_files: []

    scrape_configs:
      # Prometheus self-monitoring
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

      # Meta-OS API metrics
      - job_name: 'metaos'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - deparrow
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: metaos

      # Orchestrator metrics
      - job_name: 'orchestrator'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - deparrow
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: orchestrator

      # Compute nodes metrics
      - job_name: 'compute-nodes'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - deparrow
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: compute-node

      # PostgreSQL metrics (via postgres_exporter)
      - job_name: 'postgres'
        static_configs:
          - targets: ['postgres-exporter:9187']

      # Redis metrics
      - job_name: 'redis'
        static_configs:
          - targets: ['redis-exporter:9121']

      # Kubernetes nodes
      - job_name: 'kubernetes-nodes'
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)

      # Kubernetes pods
      - job_name: 'kubernetes-pods'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
