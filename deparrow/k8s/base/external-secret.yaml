# =============================================================================
# External Secrets Operator Configuration
# =============================================================================
#
# This file defines ExternalSecret resources that sync secrets from external
# secret stores (AWS Secrets Manager, Azure Key Vault, HashiCorp Vault, GCP
# Secret Manager) into Kubernetes secrets.
#
# Prerequisites:
#   1. Install External Secrets Operator:
#      kubectl apply -f https://github.com/external-secrets/external-secrets/releases/latest/download/bundle.yaml
#
#   2. Create a SecretStore (see examples below)
#
#   3. Create secrets in your external secret store with the following keys:
#      - deparrow-jwt-secret
#      - deparrow-secret-key
#      - postgres-password
#      - postgres-replication-password
#      - redis-password
#      - grafana-admin-user
#      - grafana-admin-password
#      - anthropic-api-key (optional)
#      - openai-api-key (optional)
#
# Documentation: https://external-secrets.io
# =============================================================================

# =============================================================================
# SecretStore Examples (choose one based on your infrastructure)
# =============================================================================

---
# AWS Secrets Manager SecretStore
# Requires: IAM permissions for secretsmanager:GetSecretValue
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: deparrow-secretstore-aws
  labels:
    app.kubernetes.io/name: deparrow
    app.kubernetes.io/component: secrets
  annotations:
    deparrow.io/provider: "aws-secrets-manager"
    deparrow.io/region: "${AWS_REGION:-us-east-1}"
spec:
  provider:
    aws:
      service: SecretsManager
      region: ${AWS_REGION:-us-east-1}
      # Use IAM roles for service accounts (IRSA) - recommended for EKS
      # auth:
      #   jwt:
      #     serviceAccountRef:
      #       name: deparrow-external-secrets-sa

---
# Azure Key Vault SecretStore
# Requires: Azure AD Workload Identity or Service Principal
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: deparrow-secretstore-azure
  labels:
    app.kubernetes.io/name: deparrow
    app.kubernetes.io/component: secrets
  annotations:
    deparrow.io/provider: "azure-key-vault"
spec:
  provider:
    azurekv:
      tenantId: "${AZURE_TENANT_ID}"
      vaultUrl: "https://${AZURE_KEYVAULT_NAME}.vault.azure.net"
      # Use Workload Identity - recommended for AKS
      # authManagedIdentity:
      #   identityId: "${USER_ASSIGNED_IDENTITY_ID}"

---
# HashiCorp Vault SecretStore
# Requires: Vault Kubernetes auth method configured
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: deparrow-secretstore-vault
  labels:
    app.kubernetes.io/name: deparrow
    app.kubernetes.io/component: secrets
  annotations:
    deparrow.io/provider: "hashicorp-vault"
spec:
  provider:
    vault:
      server: "${VAULT_ADDR}"
      path: secret
      version: v2
      auth:
        kubernetes:
          mountPath: kubernetes
          role: deparrow-secrets-role
          serviceAccountRef:
            name: deparrow-external-secrets-sa

---
# GCP Secret Manager SecretStore
# Requires: GCP Workload Identity
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: deparrow-secretstore-gcp
  labels:
    app.kubernetes.io/name: deparrow
    app.kubernetes.io/component: secrets
  annotations:
    deparrow.io/provider: "gcp-secret-manager"
spec:
  provider:
    gcpsm:
      projectID: "${GCP_PROJECT_ID}"
      # auth:
      #   workloadIdentity:
      #     serviceAccountRef:
      #       name: deparrow-external-secrets-sa
      #     clusterLocation: "${GCP_CLUSTER_LOCATION}"
      #     clusterName: "${GCP_CLUSTER_NAME}"

# =============================================================================
# ExternalSecret Definitions
# =============================================================================

---
# Main DEparrow Application Secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: deparrow-secrets-external
  labels:
    app.kubernetes.io/name: deparrow
    app.kubernetes.io/component: secrets
    app.kubernetes.io/part-of: deparrow-platform
  annotations:
    deparrow.io/managed-by: "external-secrets-operator"
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: deparrow-secretstore  # Set this to your chosen SecretStore
  target:
    name: deparrow-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: deparrow
          app.kubernetes.io/component: secrets
          app.kubernetes.io/part-of: deparrow-platform
          deparrow.io/managed-by: "external-secrets-operator"
  data:
    # JWT Secrets
    - secretKey: DEPARROW_JWT_SECRET
      remoteRef:
        key: deparrow/jwt-secret
        property: value
    - secretKey: DEPARROW_SECRET_KEY
      remoteRef:
        key: deparrow/secret-key
        property: value
    
    # Database Credentials
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: deparrow/database
        property: password
    - secretKey: POSTGRES_REPLICATION_PASSWORD
      remoteRef:
        key: deparrow/database
        property: replication_password
    
    # Redis Credentials
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: deparrow/redis
        property: password
    
    # Grafana Credentials
    - secretKey: GRAFANA_ADMIN_USER
      remoteRef:
        key: deparrow/grafana
        property: admin_user
    - secretKey: GRAFANA_ADMIN_PASSWORD
      remoteRef:
        key: deparrow/grafana
        property: admin_password
    
    # External API Keys (optional)
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: deparrow/api-keys
        property: anthropic_api_key
        optional: true
    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: deparrow/api-keys
        property: openai_api_key
        optional: true

---
# PostgreSQL Credentials ExternalSecret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials-external
  labels:
    app.kubernetes.io/name: postgres
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: deparrow-platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: deparrow-secretstore
  target:
    name: postgres-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: postgres
          app.kubernetes.io/component: database
          app.kubernetes.io/part-of: deparrow-platform
  data:
    - secretKey: POSTGRES_USER
      remoteRef:
        key: deparrow/database
        property: username
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: deparrow/database
        property: password
    - secretKey: POSTGRES_DB
      remoteRef:
        key: deparrow/database
        property: database

---
# Redis Credentials ExternalSecret
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials-external
  labels:
    app.kubernetes.io/name: redis
    app.kubernetes.io/component: cache
    app.kubernetes.io/part-of: deparrow-platform
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: SecretStore
    name: deparrow-secretstore
  target:
    name: redis-credentials
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: redis
          app.kubernetes.io/component: cache
          app.kubernetes.io/part-of: deparrow-platform
  data:
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: deparrow/redis
        property: password

# =============================================================================
# ServiceAccount for External Secrets (required for IRSA/Workload Identity)
# =============================================================================
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: deparrow-external-secrets-sa
  labels:
    app.kubernetes.io/name: deparrow
    app.kubernetes.io/component: external-secrets
  annotations:
    # AWS IRSA (EKS)
    # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/DeparrowExternalSecretsRole
    
    # Azure Workload Identity (AKS)
    # azure.workload.identity/client-id: "${AZURE_CLIENT_ID}"
    
    # GCP Workload Identity (GKE)
    # iam.gke.io/gcp-service-account: deparrow-external-secrets@PROJECT_ID.iam.gserviceaccount.com
automountServiceAccountToken: true
