# =============================================================================
# Staging External Secrets Configuration
# =============================================================================
#
# External Secrets Operator configuration for staging environment.
# Uses staging-specific secret paths and lower refresh intervals.
#
# Secret paths follow pattern: deparrow/staging/<service>/<key>
# =============================================================================

---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: deparrow-secrets-external-staging
  labels:
    deparrow.io/environment: staging
  annotations:
    deparrow.io/secret-store: "${SECRET_STORE_NAME:-deparrow-secretstore-staging}"
spec:
  refreshInterval: 10m
  secretStoreRef:
    kind: SecretStore
    name: ${SECRET_STORE_NAME:-deparrow-secretstore-staging}
  target:
    name: deparrow-secrets-staging
    creationPolicy: Owner
    deletionPolicy: Delete
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: deparrow
          app.kubernetes.io/component: secrets
          deparrow.io/environment: staging
          deparrow.io/managed-by: "external-secrets-operator"
  data:
    - secretKey: DEPARROW_JWT_SECRET
      remoteRef:
        key: deparrow/staging/jwt-secret
    - secretKey: DEPARROW_SECRET_KEY
      remoteRef:
        key: deparrow/staging/secret-key
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: deparrow/staging/database/password
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: deparrow/staging/redis/password
    - secretKey: GRAFANA_ADMIN_PASSWORD
      remoteRef:
        key: deparrow/staging/grafana/admin-password

---
# Staging PostgreSQL Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials-external-staging
  labels:
    deparrow.io/environment: staging
spec:
  refreshInterval: 10m
  secretStoreRef:
    kind: SecretStore
    name: ${SECRET_STORE_NAME:-deparrow-secretstore-staging}
  target:
    name: postgres-credentials-staging
    creationPolicy: Owner
    deletionPolicy: Delete
  data:
    - secretKey: POSTGRES_USER
      remoteRef:
        key: deparrow/staging/database/username
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: deparrow/staging/database/password
    - secretKey: POSTGRES_DB
      remoteRef:
        key: deparrow/staging/database/name

---
# Staging Redis Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials-external-staging
  labels:
    deparrow.io/environment: staging
spec:
  refreshInterval: 10m
  secretStoreRef:
    kind: SecretStore
    name: ${SECRET_STORE_NAME:-deparrow-secretstore-staging}
  target:
    name: redis-credentials-staging
    creationPolicy: Owner
    deletionPolicy: Delete
  data:
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: deparrow/staging/redis/password

---
# ServiceAccount for staging
apiVersion: v1
kind: ServiceAccount
metadata:
  name: deparrow-external-secrets-sa
  annotations:
    deparrow.io/environment: staging
    # Uncomment and configure for your cloud provider
    # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/DeparrowStagingSecretsRole
