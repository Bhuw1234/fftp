# =============================================================================
# Production External Secrets Configuration
# =============================================================================
#
# This patch enables External Secrets Operator for production deployments.
# It replaces the placeholder secrets with externally-managed secrets.
#
# Prerequisites:
#   1. External Secrets Operator installed in cluster
#   2. SecretStore configured (AWS/Azure/GCP/Vault)
#   3. Secrets created in external secret store
#   4. ServiceAccount with appropriate permissions
#
# Usage:
#   kubectl apply -k overlays/production
#
# Secret Store Setup:
#   Set the SECRET_STORE_NAME environment variable or update the patch
#   to reference your SecretStore name.
# =============================================================================

---
# Patch the base secrets to add production annotations
apiVersion: v1
kind: Secret
metadata:
  name: deparrow-secrets
  annotations:
    # Mark for deletion when ExternalSecret takes over
    deparrow.io/secret-source: "external-secrets-operator"
    deparrow.io/secret-store: "${SECRET_STORE_NAME:-deparrow-secretstore}"

---
# Enable ExternalSecret for production
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: deparrow-secrets-external
  labels:
    deparrow.io/environment: production
  annotations:
    deparrow.io/secret-store: "${SECRET_STORE_NAME:-deparrow-secretstore}"
spec:
  refreshInterval: 5m  # More frequent refresh for production
  secretStoreRef:
    kind: SecretStore
    name: ${SECRET_STORE_NAME:-deparrow-secretstore}
  target:
    name: deparrow-secrets
    creationPolicy: Owner
    deletionPolicy: Delete  # Clean up on ExternalSecret deletion
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: deparrow
          app.kubernetes.io/component: secrets
          app.kubernetes.io/part-of: deparrow-platform
          deparrow.io/environment: production
          deparrow.io/managed-by: "external-secrets-operator"
  dataFrom:
    # Use dataFrom for AWS Secrets Manager JSON secrets
    - extract:
        key: deparrow/production/secrets
      rewrite:
        - regexp:
            source: "(.*)"
            target: "$1"

---
# PostgreSQL Credentials for Production
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: postgres-credentials-external
  labels:
    deparrow.io/environment: production
spec:
  refreshInterval: 5m
  secretStoreRef:
    kind: SecretStore
    name: ${SECRET_STORE_NAME:-deparrow-secretstore}
  target:
    name: postgres-credentials
    creationPolicy: Owner
    deletionPolicy: Delete
  data:
    - secretKey: POSTGRES_USER
      remoteRef:
        key: deparrow/production/database
        property: username
    - secretKey: POSTGRES_PASSWORD
      remoteRef:
        key: deparrow/production/database
        property: password
    - secretKey: POSTGRES_DB
      remoteRef:
        key: deparrow/production/database
        property: database

---
# Redis Credentials for Production
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: redis-credentials-external
  labels:
    deparrow.io/environment: production
spec:
  refreshInterval: 5m
  secretStoreRef:
    kind: SecretStore
    name: ${SECRET_STORE_NAME:-deparrow-secretstore}
  target:
    name: redis-credentials
    creationPolicy: Owner
    deletionPolicy: Delete
  data:
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: deparrow/production/redis
        property: password

---
# ServiceAccount for External Secrets with production annotations
apiVersion: v1
kind: ServiceAccount
metadata:
  name: deparrow-external-secrets-sa
  annotations:
    deparrow.io/environment: production
    # AWS IRSA - uncomment and set your role ARN
    # eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/DeparrowProductionSecretsRole
    
    # Azure Workload Identity - uncomment and set your client ID
    # azure.workload.identity/client-id: "${AZURE_PRODUCTION_CLIENT_ID}"
    
    # GCP Workload Identity - uncomment and set your service account
    # iam.gke.io/gcp-service-account: deparrow-prod-secrets@PROJECT_ID.iam.gserviceaccount.com
